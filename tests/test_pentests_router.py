"""Tests for the pentests API router."""

from __future__ import annotations

import os
import sqlite3

# ── Bootstrap: patch DB connections BEFORE importing api.main ──────
os.environ["NEURALWARDEN_DB_PATH"] = ":memory:"

# Create a shared in-memory connection that won't actually close
_shared_conn = sqlite3.connect(":memory:", check_same_thread=False)
_shared_conn.row_factory = sqlite3.Row
_shared_conn.execute("PRAGMA foreign_keys = ON")


class _NonClosingConnection:
    """Wraps a real connection so close() is a no-op."""
    def __init__(self, real_conn):
        self._conn = real_conn
    def close(self):
        pass
    def __getattr__(self, name):
        return getattr(self._conn, name)


_wrapper = _NonClosingConnection(_shared_conn)

# Patch _sqlite_conn in api.db so ALL modules that call get_conn() use our wrapper
import api.db
api.db._sqlite_conn = lambda: _wrapper

import pytest
from fastapi.testclient import TestClient

from api.auth import get_current_user
from api.main import app

TEST_USER = "test@test.com"
OTHER_USER = "other@test.com"
app.dependency_overrides[get_current_user] = lambda: TEST_USER

client = TestClient(app)

HEADERS: dict[str, str] = {}
OTHER_HEADERS: dict[str, str] = {}


# ── Pentest CRUD ──────────────────────────────────────────────────────


def test_list_empty():
    """Initially no pentests exist for a user."""
    res = client.get("/api/pentests", headers=HEADERS)
    assert res.status_code == 200
    assert res.json() == []


def test_create_pentest():
    """Create a pentest and verify fields."""
    res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Q1 2026 External", "vendor": "synack", "severity": "high"},
    )
    assert res.status_code == 201
    data = res.json()
    assert data["name"] == "Q1 2026 External"
    assert data["vendor"] == "synack"
    assert data["severity"] == "high"
    assert data["status"] == "planned"
    assert "finding_counts" in data
    assert data["finding_counts"]["total"] == 0


def test_list_pentests():
    """After creating, pentests appear in list."""
    res = client.get("/api/pentests", headers=HEADERS)
    assert res.status_code == 200
    pentests = res.json()
    assert len(pentests) >= 1
    assert any(p["name"] == "Q1 2026 External" for p in pentests)


def test_get_pentest():
    """Get a pentest by ID."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Get Test"},
    )
    pentest_id = create_res.json()["id"]

    res = client.get(f"/api/pentests/{pentest_id}", headers=HEADERS)
    assert res.status_code == 200
    assert res.json()["name"] == "Get Test"


def test_get_pentest_wrong_user():
    """Other users can't see my pentests."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Private Test"},
    )
    pentest_id = create_res.json()["id"]

    # Switch to a different user
    app.dependency_overrides[get_current_user] = lambda: OTHER_USER
    res = client.get(f"/api/pentests/{pentest_id}", headers=OTHER_HEADERS)
    assert res.status_code == 404

    # Restore original user
    app.dependency_overrides[get_current_user] = lambda: TEST_USER


def test_update_pentest():
    """Update a pentest's fields."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Update Test"},
    )
    pentest_id = create_res.json()["id"]

    res = client.put(
        f"/api/pentests/{pentest_id}",
        headers=HEADERS,
        json={"status": "in_progress", "name": "Updated Name"},
    )
    assert res.status_code == 200
    assert res.json()["status"] == "in_progress"
    assert res.json()["name"] == "Updated Name"


def test_delete_pentest():
    """Delete a pentest."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Delete Test"},
    )
    pentest_id = create_res.json()["id"]

    res = client.delete(f"/api/pentests/{pentest_id}", headers=HEADERS)
    assert res.status_code == 200
    assert res.json()["detail"] == "deleted"

    # Verify it's gone
    res = client.get(f"/api/pentests/{pentest_id}", headers=HEADERS)
    assert res.status_code == 404


# ── Findings ──────────────────────────────────────────────────────────


def test_create_finding():
    """Create a finding under a pentest."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Findings Test"},
    )
    pentest_id = create_res.json()["id"]

    res = client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={
            "title": "SQL Injection in login",
            "severity": "critical",
            "cvss_score": 9.8,
            "category": "injection",
        },
    )
    assert res.status_code == 201
    data = res.json()
    assert data["title"] == "SQL Injection in login"
    assert data["severity"] == "critical"
    assert data["cvss_score"] == 9.8


def test_list_findings():
    """List findings for a pentest."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "List Findings Test"},
    )
    pentest_id = create_res.json()["id"]

    # Add two findings
    client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "XSS in search", "severity": "high"},
    )
    client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "IDOR in profiles", "severity": "medium"},
    )

    res = client.get(f"/api/pentests/{pentest_id}/findings", headers=HEADERS)
    assert res.status_code == 200
    findings = res.json()
    assert len(findings) == 2
    # Should be sorted by severity (high before medium)
    assert findings[0]["severity"] == "high"
    assert findings[1]["severity"] == "medium"


def test_list_findings_filter_severity():
    """Filter findings by severity."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Filter Test"},
    )
    pentest_id = create_res.json()["id"]

    client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "Critical Bug", "severity": "critical"},
    )
    client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "Low Bug", "severity": "low"},
    )

    res = client.get(
        f"/api/pentests/{pentest_id}/findings?severity=critical",
        headers=HEADERS,
    )
    assert res.status_code == 200
    findings = res.json()
    assert len(findings) == 1
    assert findings[0]["severity"] == "critical"


def test_update_finding():
    """Update a finding's status and verify resolved_at auto-set."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Update Finding Test"},
    )
    pentest_id = create_res.json()["id"]

    finding_res = client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "Open Bug", "severity": "high"},
    )
    finding_id = finding_res.json()["id"]

    res = client.patch(
        f"/api/pentests/findings/{finding_id}",
        headers=HEADERS,
        json={"status": "resolved"},
    )
    assert res.status_code == 200
    assert res.json()["status"] == "resolved"
    assert res.json()["resolved_at"] is not None


def test_finding_counts():
    """Pentest response includes accurate finding_counts."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Counts Test"},
    )
    pentest_id = create_res.json()["id"]

    client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "Crit1", "severity": "critical"},
    )
    client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "High1", "severity": "high"},
    )
    client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "High2", "severity": "high"},
    )

    res = client.get(f"/api/pentests/{pentest_id}", headers=HEADERS)
    counts = res.json()["finding_counts"]
    assert counts["critical"] == 1
    assert counts["high"] == 2
    assert counts["total"] == 3


def test_bulk_import():
    """Bulk import findings."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Import Test"},
    )
    pentest_id = create_res.json()["id"]

    res = client.post(
        f"/api/pentests/{pentest_id}/import",
        headers=HEADERS,
        json={
            "findings": [
                {"title": "Import 1", "severity": "high"},
                {"title": "Import 2", "severity": "medium"},
                {"title": "Import 3", "severity": "low"},
            ]
        },
    )
    assert res.status_code == 200
    assert res.json()["imported"] == 3

    # Verify they exist
    findings_res = client.get(
        f"/api/pentests/{pentest_id}/findings", headers=HEADERS
    )
    assert len(findings_res.json()) == 3


def test_delete_cascades_findings():
    """Deleting a pentest also deletes its findings."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Cascade Test"},
    )
    pentest_id = create_res.json()["id"]

    client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "Cascade Finding"},
    )

    # Delete the pentest
    client.delete(f"/api/pentests/{pentest_id}", headers=HEADERS)

    # Pentest gone
    res = client.get(f"/api/pentests/{pentest_id}", headers=HEADERS)
    assert res.status_code == 404


# ── Checks catalog ───────────────────────────────────────────────────


def test_list_checks():
    """List all 13 seeded checks."""
    res = client.get("/api/pentests/checks")
    assert res.status_code == 200
    checks = res.json()
    assert len(checks) == 13
    # Each check has required fields
    for c in checks:
        assert "rule_code" in c
        assert "title" in c
        assert "group_name" in c
        assert "subchecks" in c
        assert isinstance(c["subchecks"], list)


def test_list_checks_filter_group():
    """Filter checks by group."""
    res = client.get("/api/pentests/checks?group=owasp")
    assert res.status_code == 200
    checks = res.json()
    assert len(checks) == 7
    assert all(c["group_name"] == "owasp" for c in checks)

    res = client.get("/api/pentests/checks?group=advanced")
    assert res.status_code == 200
    assert len(res.json()) == 4

    res = client.get("/api/pentests/checks?group=hardening")
    assert res.status_code == 200
    assert len(res.json()) == 2


# ── Enhanced finding fields ──────────────────────────────────────────


def test_enhanced_finding_fields():
    """Create a finding with CVE/CWE and validation fields."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Enhanced Finding Test"},
    )
    pentest_id = create_res.json()["id"]

    res = client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={
            "title": "SQL Injection in search",
            "severity": "critical",
            "cwe_id": "CWE-89",
            "cve_id": "CVE-2024-1234",
            "request_data": "GET /search?q=' OR 1=1--",
            "response_data": "HTTP/1.1 500 Internal Server Error",
            "validation_status": "confirmed",
            "validation_notes": "Verified with sqlmap",
            "check_rule_code": "sql_injection",
        },
    )
    assert res.status_code == 201
    data = res.json()
    assert data["cwe_id"] == "CWE-89"
    assert data["cve_id"] == "CVE-2024-1234"
    assert data["request_data"] == "GET /search?q=' OR 1=1--"
    assert data["response_data"] == "HTTP/1.1 500 Internal Server Error"
    assert data["validation_status"] == "confirmed"
    assert data["validation_notes"] == "Verified with sqlmap"
    assert data["check_rule_code"] == "sql_injection"


def test_update_finding_validation():
    """Update validation status on a finding."""
    create_res = client.post(
        "/api/pentests",
        headers=HEADERS,
        json={"name": "Validation Update Test"},
    )
    pentest_id = create_res.json()["id"]

    finding_res = client.post(
        f"/api/pentests/{pentest_id}/findings",
        headers=HEADERS,
        json={"title": "Unverified Bug", "severity": "high"},
    )
    finding_id = finding_res.json()["id"]
    assert finding_res.json()["validation_status"] == "unverified"

    res = client.patch(
        f"/api/pentests/findings/{finding_id}",
        headers=HEADERS,
        json={"validation_status": "confirmed", "validation_notes": "Reproduced manually"},
    )
    assert res.status_code == 200
    assert res.json()["validation_status"] == "confirmed"
    assert res.json()["validation_notes"] == "Reproduced manually"
