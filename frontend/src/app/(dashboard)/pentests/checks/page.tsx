"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import PageShell from "@/components/PageShell";
import { listPentestChecks } from "@/lib/api";
import type { PentestCheck } from "@/lib/types";

const GROUP_PILLS = [
  { key: null, label: "All" },
  { key: "owasp", label: "OWASP Top 10" },
  { key: "advanced", label: "Advanced" },
  { key: "hardening", label: "Hardening" },
] as const;

const GROUP_STYLES: Record<string, string> = {
  owasp: "bg-red-500/10 text-red-400 border-red-500/30",
  advanced: "bg-purple-500/10 text-purple-400 border-purple-500/30",
  hardening: "bg-cyan-500/10 text-cyan-400 border-cyan-500/30",
};

const SEVERITY_STYLES: Record<string, string> = {
  critical: "bg-red-500/10 text-red-400 border-red-500/30",
  high: "bg-orange-500/10 text-orange-400 border-orange-500/30",
  medium: "bg-yellow-500/10 text-yellow-400 border-yellow-500/30",
  low: "bg-blue-500/10 text-blue-400 border-blue-500/30",
};

export default function ChecksPage() {
  const router = useRouter();
  const [checks, setChecks] = useState<PentestCheck[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [groupFilter, setGroupFilter] = useState<string | null>(null);
  const [search, setSearch] = useState("");
  const [expandedId, setExpandedId] = useState<string | null>(null);

  useEffect(() => {
    loadChecks();
  }, []);

  async function loadChecks() {
    try {
      setLoading(true);
      const data = await listPentestChecks();
      setChecks(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to load checks");
    } finally {
      setLoading(false);
    }
  }

  const filtered = checks
    .filter((c) => !groupFilter || c.group_name === groupFilter)
    .filter(
      (c) =>
        c.title.toLowerCase().includes(search.toLowerCase()) ||
        c.description.toLowerCase().includes(search.toLowerCase()) ||
        c.rule_code.toLowerCase().includes(search.toLowerCase())
    );

  return (
    <PageShell
      title="Pentests"
      description="Penetration testing campaigns and results"
      icon={
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="10" />
          <path d="M12 16v-4M12 8h.01" />
        </svg>
      }
    >
      {/* Section tabs */}
      <div className="flex gap-1 mt-4 mb-5 border-b border-[#30363d] pb-3">
        <button
          onClick={() => router.push("/pentests")}
          className="px-4 py-2 rounded-lg text-xs font-semibold transition-colors bg-[#21262d] text-[#8b949e] border border-[#30363d] hover:bg-[#262c34]"
        >
          Projects
        </button>
        <button className="px-4 py-2 rounded-lg text-xs font-semibold transition-colors bg-primary text-white">
          Checks
        </button>
      </div>

      {!loading && (
        <>
          {/* Search + group filters */}
          <div className="flex items-center gap-3 mb-5">
            <div className="relative flex-1 max-w-md">
              <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none text-[#8b949e]">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <circle cx="11" cy="11" r="8" />
                  <path d="M21 21l-4.35-4.35" />
                </svg>
              </div>
              <input
                type="text"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                placeholder="Search checks..."
                className="w-full pl-10 pr-4 py-2 border border-[#30363d] rounded-lg text-sm bg-[#21262d] text-white focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
              />
            </div>
          </div>

          {/* Group filter pills */}
          <div className="flex gap-1 mb-5">
            {GROUP_PILLS.map((pill) => (
              <button
                key={pill.label}
                onClick={() => setGroupFilter(pill.key)}
                className={`px-4 py-2 rounded-lg text-xs font-semibold transition-colors cursor-pointer ${
                  groupFilter === pill.key
                    ? "bg-primary text-white"
                    : "bg-[#21262d] text-[#8b949e] border border-[#30363d] hover:bg-[#262c34]"
                }`}
              >
                {pill.label}
              </button>
            ))}
            <span className="ml-auto inline-flex items-center gap-1.5 px-2.5 py-1 bg-[#00e68a]/10 text-[#00e68a] text-xs font-semibold rounded-full border border-[#00e68a]/20">
              {filtered.length} check{filtered.length !== 1 ? "s" : ""}
            </span>
          </div>
        </>
      )}

      {/* Loading */}
      {loading && (
        <div className="flex items-center justify-center py-20">
          <div className="w-8 h-8 border-3 border-primary/30 border-t-primary rounded-full animate-spin" />
        </div>
      )}

      {/* Error */}
      {error && (
        <div className="p-4 bg-red-950/20 border border-red-500/30 rounded-xl text-red-400 text-sm mb-4">
          {error}
        </div>
      )}

      {/* Table */}
      {!loading && !error && filtered.length > 0 && (
        <div className="bg-[#1c2128] rounded-xl border border-[#30363d] overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-[#21262d] border-b border-[#30363d]">
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3 w-8" />
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">Check</th>
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">Group</th>
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">Severity</th>
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">CWE</th>
                <th className="text-right text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">Subchecks</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[#262c34]">
              {filtered.map((check) => (
                <CheckRow
                  key={check.id}
                  check={check}
                  expanded={expandedId === check.id}
                  onToggle={() => setExpandedId(expandedId === check.id ? null : check.id)}
                />
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Empty state */}
      {!loading && !error && filtered.length === 0 && (
        <div className="text-center py-12 text-[#8b949e] text-sm">
          No checks match your filters.
        </div>
      )}
    </PageShell>
  );
}

function CheckRow({
  check,
  expanded,
  onToggle,
}: {
  check: PentestCheck;
  expanded: boolean;
  onToggle: () => void;
}) {
  const groupStyle = GROUP_STYLES[check.group_name] ?? "bg-gray-500/10 text-gray-400";
  const sevStyle = SEVERITY_STYLES[check.severity_default] ?? "";

  return (
    <>
      <tr
        onClick={onToggle}
        className="hover:bg-[#21262d] cursor-pointer transition-colors"
      >
        <td className="px-5 py-3.5">
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#8b949e"
            strokeWidth="2"
            className={`transition-transform ${expanded ? "rotate-90" : ""}`}
          >
            <polyline points="9 18 15 12 9 6" />
          </svg>
        </td>
        <td className="px-5 py-3.5">
          <div className="text-sm font-medium text-white">{check.title}</div>
          <div className="text-xs text-[#8b949e] mt-0.5 line-clamp-1">{check.description}</div>
        </td>
        <td className="px-5 py-3.5">
          <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold uppercase border ${groupStyle}`}>
            {check.group_name}
          </span>
        </td>
        <td className="px-5 py-3.5">
          <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold uppercase border ${sevStyle}`}>
            {check.severity_default}
          </span>
        </td>
        <td className="px-5 py-3.5">
          <span className="text-xs text-[#8b949e] font-mono">{check.cwe_ids || "â€”"}</span>
        </td>
        <td className="px-5 py-3.5 text-right">
          <span className="text-xs text-[#8b949e]">{check.subchecks.length}</span>
        </td>
      </tr>
      {expanded && (
        <tr className="bg-[#161b22]">
          <td colSpan={6} className="px-5 py-4">
            <div className="pl-8">
              <div className="text-xs font-semibold text-[#8b949e] uppercase tracking-wider mb-2">
                Subchecks ({check.subchecks.length})
              </div>
              <ul className="space-y-1.5">
                {check.subchecks.map((sub, i) => (
                  <li key={i} className="flex items-start gap-2 text-sm text-[#c9d1d9]">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8b949e" strokeWidth="2" className="shrink-0 mt-0.5">
                      <circle cx="12" cy="12" r="2" />
                    </svg>
                    {sub}
                  </li>
                ))}
              </ul>
            </div>
          </td>
        </tr>
      )}
    </>
  );
}
