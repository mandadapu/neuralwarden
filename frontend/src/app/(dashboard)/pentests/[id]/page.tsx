"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import { usePentestContext } from "./layout";
import FindingDetailModal from "@/components/FindingDetailModal";
import { listFindings, createFinding } from "@/lib/api";
import type { PentestFinding } from "@/lib/types";

const SEVERITY_STYLES: Record<string, string> = {
  critical: "bg-red-500/10 text-red-400 border-red-500/30",
  high: "bg-orange-500/10 text-orange-400 border-orange-500/30",
  medium: "bg-yellow-500/10 text-yellow-400 border-yellow-500/30",
  low: "bg-blue-500/10 text-blue-400 border-blue-500/30",
};

const STATUS_STYLES: Record<string, string> = {
  open: "bg-red-500/10 text-red-400",
  in_progress: "bg-blue-500/10 text-blue-400",
  resolved: "bg-emerald-500/10 text-emerald-400",
  accepted_risk: "bg-yellow-500/10 text-yellow-400",
  false_positive: "bg-[#30363d] text-[#8b949e]",
};

const STATUS_LABELS: Record<string, string> = {
  open: "Open",
  in_progress: "In Progress",
  resolved: "Resolved",
  accepted_risk: "Accepted",
  false_positive: "False Positive",
};

export default function FindingsPage() {
  const params = useParams();
  const pentestId = params.id as string;
  const { pentest, refresh } = usePentestContext();

  const [findings, setFindings] = useState<PentestFinding[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedFinding, setSelectedFinding] = useState<PentestFinding | null>(null);
  const [showAddForm, setShowAddForm] = useState(false);
  const [statusFilter, setStatusFilter] = useState("");
  const [severityFilter, setSeverityFilter] = useState("");

  // Quick add form state
  const [newTitle, setNewTitle] = useState("");
  const [newSeverity, setNewSeverity] = useState("medium");
  const [newCategory, setNewCategory] = useState("");
  const [addingFinding, setAddingFinding] = useState(false);

  useEffect(() => {
    loadFindings();
  }, [pentestId, statusFilter, severityFilter]);

  async function loadFindings() {
    try {
      setLoading(true);
      const data = await listFindings(pentestId, statusFilter || undefined, severityFilter || undefined);
      setFindings(data);
    } catch {
      setFindings([]);
    } finally {
      setLoading(false);
    }
  }

  async function handleAddFinding() {
    if (!newTitle.trim()) return;
    setAddingFinding(true);
    try {
      const created = await createFinding(pentestId, {
        title: newTitle.trim(),
        severity: newSeverity,
        category: newCategory,
      });
      setFindings((prev) => [...prev, created]);
      setNewTitle("");
      setNewCategory("");
      setShowAddForm(false);
      refresh();
    } catch (err) {
      console.error("Failed to add finding:", err);
    } finally {
      setAddingFinding(false);
    }
  }

  function handleFindingUpdate(updated: PentestFinding) {
    setFindings((prev) => prev.map((f) => (f.id === updated.id ? updated : f)));
    setSelectedFinding(null);
    refresh();
  }

  return (
    <div>
      {/* Controls */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
            className="px-3 py-1.5 border border-[#30363d] rounded-lg text-xs bg-[#21262d] text-[#c9d1d9] focus:outline-none focus:ring-2 focus:ring-primary/20"
          >
            <option value="">All Statuses</option>
            <option value="open">Open</option>
            <option value="in_progress">In Progress</option>
            <option value="resolved">Resolved</option>
            <option value="accepted_risk">Accepted Risk</option>
            <option value="false_positive">False Positive</option>
          </select>
          <select
            value={severityFilter}
            onChange={(e) => setSeverityFilter(e.target.value)}
            className="px-3 py-1.5 border border-[#30363d] rounded-lg text-xs bg-[#21262d] text-[#c9d1d9] focus:outline-none focus:ring-2 focus:ring-primary/20"
          >
            <option value="">All Severities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <button
          onClick={() => setShowAddForm(!showAddForm)}
          className="inline-flex items-center gap-2 px-4 py-2 bg-primary text-white text-sm font-semibold rounded-lg hover:bg-primary-hover transition-colors"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
            <path d="M12 5v14M5 12h14" />
          </svg>
          Add Finding
        </button>
      </div>

      {/* Quick add form */}
      {showAddForm && (
        <div className="mb-4 p-4 bg-[#21262d] rounded-xl border border-[#30363d]">
          <div className="flex items-end gap-3">
            <div className="flex-1">
              <label className="block text-xs font-medium text-[#8b949e] mb-1">Title *</label>
              <input
                type="text"
                value={newTitle}
                onChange={(e) => setNewTitle(e.target.value)}
                placeholder="e.g., SQL Injection in login form"
                className="w-full px-3 py-2 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white placeholder:text-[#484f58] focus:outline-none focus:ring-2 focus:ring-primary/20"
              />
            </div>
            <div className="w-32">
              <label className="block text-xs font-medium text-[#8b949e] mb-1">Severity</label>
              <select
                value={newSeverity}
                onChange={(e) => setNewSeverity(e.target.value)}
                className="w-full px-3 py-2 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white focus:outline-none focus:ring-2 focus:ring-primary/20"
              >
                <option value="critical">Critical</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div className="w-40">
              <label className="block text-xs font-medium text-[#8b949e] mb-1">Category</label>
              <input
                type="text"
                value={newCategory}
                onChange={(e) => setNewCategory(e.target.value)}
                placeholder="e.g., injection"
                className="w-full px-3 py-2 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white placeholder:text-[#484f58] focus:outline-none focus:ring-2 focus:ring-primary/20"
              />
            </div>
            <button
              onClick={handleAddFinding}
              disabled={addingFinding || !newTitle.trim()}
              className="px-4 py-2 bg-primary text-white text-sm font-semibold rounded-lg hover:bg-primary-hover disabled:opacity-50 transition-colors"
            >
              {addingFinding ? "Adding..." : "Add"}
            </button>
            <button
              onClick={() => setShowAddForm(false)}
              className="px-3 py-2 text-sm text-[#8b949e] hover:text-white transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      )}

      {/* Loading */}
      {loading && (
        <div className="flex items-center justify-center py-16">
          <div className="w-6 h-6 border-2 border-primary/30 border-t-primary rounded-full animate-spin" />
        </div>
      )}

      {/* Empty */}
      {!loading && findings.length === 0 && (
        <div className="py-16 text-center">
          <p className="text-sm text-[#8b949e]">No findings yet. Add your first finding.</p>
        </div>
      )}

      {/* Findings table */}
      {!loading && findings.length > 0 && (
        <div className="bg-[#1c2128] rounded-xl border border-[#30363d] overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-[#21262d] border-b border-[#30363d]">
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">Severity</th>
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">Title</th>
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3 w-20">CVSS</th>
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">Category</th>
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">Status</th>
                <th className="text-left text-xs font-semibold text-[#8b949e] uppercase tracking-wider px-5 py-3">URL</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[#262c34]">
              {findings.map((f) => (
                <tr
                  key={f.id}
                  onClick={() => setSelectedFinding(f)}
                  className="hover:bg-[#21262d] cursor-pointer transition-colors"
                >
                  <td className="px-5 py-3.5">
                    <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold uppercase border ${SEVERITY_STYLES[f.severity] ?? ""}`}>
                      {f.severity}
                    </span>
                  </td>
                  <td className="px-5 py-3.5">
                    <span className="text-sm font-medium text-white">{f.title}</span>
                    {f.description && (
                      <p className="text-xs text-[#8b949e] mt-0.5 line-clamp-1">{f.description}</p>
                    )}
                  </td>
                  <td className="px-5 py-3.5">
                    <span className="text-sm font-mono text-[#c9d1d9]">
                      {f.cvss_score !== null ? f.cvss_score.toFixed(1) : "—"}
                    </span>
                  </td>
                  <td className="px-5 py-3.5">
                    <span className="text-xs text-[#8b949e]">{f.category || "—"}</span>
                  </td>
                  <td className="px-5 py-3.5">
                    <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold uppercase ${STATUS_STYLES[f.status] ?? ""}`}>
                      {STATUS_LABELS[f.status] ?? f.status}
                    </span>
                  </td>
                  <td className="px-5 py-3.5">
                    {f.affected_url ? (
                      <code className="text-xs text-[#8b949e] font-mono truncate block max-w-[200px]">
                        {f.affected_url}
                      </code>
                    ) : (
                      <span className="text-xs text-[#484f58]">—</span>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Finding detail modal */}
      {selectedFinding && (
        <FindingDetailModal
          finding={selectedFinding}
          open={!!selectedFinding}
          onClose={() => setSelectedFinding(null)}
          onUpdate={handleFindingUpdate}
        />
      )}
    </div>
  );
}
