"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import { listFindings } from "@/lib/api";
import type { PentestFinding } from "@/lib/types";

const SEVERITY_STYLES: Record<string, string> = {
  critical: "bg-red-500/10 text-red-400 border-red-500/30",
  high: "bg-orange-500/10 text-orange-400 border-orange-500/30",
  medium: "bg-yellow-500/10 text-yellow-400 border-yellow-500/30",
  low: "bg-blue-500/10 text-blue-400 border-blue-500/30",
};

interface TimelineEvent {
  id: string;
  timestamp: string;
  type: "discovered" | "resolved";
  finding: PentestFinding;
}

function buildTimeline(findings: PentestFinding[]): TimelineEvent[] {
  const events: TimelineEvent[] = [];

  for (const f of findings) {
    events.push({
      id: `${f.id}-discovered`,
      timestamp: f.discovered_at,
      type: "discovered",
      finding: f,
    });
    if (f.resolved_at) {
      events.push({
        id: `${f.id}-resolved`,
        timestamp: f.resolved_at,
        type: "resolved",
        finding: f,
      });
    }
  }

  // Sort newest first
  events.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
  return events;
}

function formatTimestamp(ts: string): string {
  const d = new Date(ts);
  return d.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}

export default function TimelinePage() {
  const params = useParams();
  const pentestId = params.id as string;

  const [findings, setFindings] = useState<PentestFinding[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    listFindings(pentestId)
      .then(setFindings)
      .catch(() => setFindings([]))
      .finally(() => setLoading(false));
  }, [pentestId]);

  const events = buildTimeline(findings);

  if (loading) {
    return (
      <div className="flex items-center justify-center py-16">
        <div className="w-6 h-6 border-2 border-primary/30 border-t-primary rounded-full animate-spin" />
      </div>
    );
  }

  if (events.length === 0) {
    return (
      <div className="py-16 text-center">
        <p className="text-sm text-[#8b949e]">No timeline events yet. Add findings to see events here.</p>
      </div>
    );
  }

  return (
    <div className="max-w-2xl">
      <div className="relative">
        {/* Vertical line */}
        <div className="absolute left-4 top-0 bottom-0 w-px bg-[#30363d]" />

        <div className="space-y-0">
          {events.map((event) => {
            const isDiscovered = event.type === "discovered";
            const sevStyle = SEVERITY_STYLES[event.finding.severity] ?? "";

            return (
              <div key={event.id} className="relative pl-12 py-4">
                {/* Dot */}
                <div className={`absolute left-2.5 top-5 w-3 h-3 rounded-full border-2 ${
                  isDiscovered
                    ? "bg-red-500/20 border-red-400"
                    : "bg-emerald-500/20 border-emerald-400"
                }`} />

                <div className="bg-[#21262d] rounded-xl border border-[#30363d] p-4">
                  <div className="flex items-start justify-between gap-3">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold uppercase ${
                          isDiscovered
                            ? "bg-red-500/10 text-red-400"
                            : "bg-emerald-500/10 text-emerald-400"
                        }`}>
                          {isDiscovered ? "Discovered" : "Resolved"}
                        </span>
                        <span className={`px-1.5 py-0.5 rounded-md text-[10px] font-bold uppercase border ${sevStyle}`}>
                          {event.finding.severity}
                        </span>
                      </div>
                      <p className="text-sm font-medium text-white">{event.finding.title}</p>
                      {event.finding.category && (
                        <p className="text-xs text-[#8b949e] mt-0.5">{event.finding.category}</p>
                      )}
                    </div>
                    <div className="text-right shrink-0">
                      <p className="text-xs text-[#8b949e]">{formatTimestamp(event.timestamp)}</p>
                      {event.finding.cvss_score !== null && (
                        <p className="text-xs font-mono text-[#8b949e] mt-0.5">
                          CVSS {event.finding.cvss_score}
                        </p>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}
