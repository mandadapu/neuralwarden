"use client";

import { useState, useEffect, createContext, useContext, useCallback } from "react";
import Link from "next/link";
import { useParams, usePathname, useRouter } from "next/navigation";
import CreatePentestModal from "@/components/CreatePentestModal";
import { getPentest } from "@/lib/api";
import type { Pentest } from "@/lib/types";

const SEVERITY_STYLES: Record<string, string> = {
  critical: "bg-red-500/10 text-red-400 border-red-500/30",
  high: "bg-orange-500/10 text-orange-400 border-orange-500/30",
  medium: "bg-yellow-500/10 text-yellow-400 border-yellow-500/30",
  low: "bg-blue-500/10 text-blue-400 border-blue-500/30",
};

const VENDOR_LABELS: Record<string, string> = {
  manual: "Manual",
  synack: "Synack",
  hackerone: "HackerOne",
  intigriti: "Intigriti",
};

const VENDOR_COLORS: Record<string, string> = {
  manual: "bg-[#30363d] text-[#c9d1d9]",
  synack: "bg-purple-500/10 text-purple-400 border-purple-500/30",
  hackerone: "bg-emerald-500/10 text-emerald-400 border-emerald-500/30",
  intigriti: "bg-cyan-500/10 text-cyan-400 border-cyan-500/30",
};

interface PentestContextValue {
  pentest: Pentest | null;
  loading: boolean;
  refresh: () => void;
}

const PentestContext = createContext<PentestContextValue>({
  pentest: null,
  loading: true,
  refresh: () => {},
});

export function usePentestContext() {
  return useContext(PentestContext);
}

const TABS = [
  { label: "Findings", href: "" },
  { label: "Timeline", href: "/timeline" },
];

export default function PentestDetailLayout({ children }: { children: React.ReactNode }) {
  const params = useParams();
  const pathname = usePathname();
  const router = useRouter();
  const id = params.id as string;

  const [pentest, setPentest] = useState<Pentest | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [editOpen, setEditOpen] = useState(false);

  const loadPentest = useCallback(async () => {
    try {
      setLoading(true);
      const data = await getPentest(id);
      setPentest(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to load pentest");
    } finally {
      setLoading(false);
    }
  }, [id]);

  useEffect(() => {
    loadPentest();
  }, [loadPentest]);

  function handleEditSave(updated: Pentest) {
    setPentest(updated);
    setEditOpen(false);
  }

  function handleEditDelete() {
    setEditOpen(false);
    router.push("/pentests");
  }

  const basePath = `/pentests/${id}`;
  const totalFindings = pentest?.finding_counts?.total ?? 0;

  return (
    <PentestContext.Provider value={{ pentest, loading, refresh: loadPentest }}>
      <div className="px-7 py-6">
        {/* Loading */}
        {loading && !pentest && (
          <div className="flex items-center justify-center py-20">
            <div className="w-8 h-8 border-3 border-primary/30 border-t-primary rounded-full animate-spin" />
          </div>
        )}

        {/* Error */}
        {error && (
          <div className="p-4 bg-red-950/20 border border-red-500/30 rounded-xl text-red-400 text-sm mb-4">
            {error}
          </div>
        )}

        {pentest && (
          <>
            {/* Header */}
            <div className="flex items-center justify-between mb-5">
              <div className="flex items-center gap-3">
                <Link href="/pentests" className="text-[#8b949e] hover:text-[#c9d1d9] transition-colors">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                  </svg>
                </Link>
                <div>
                  <div className="flex items-center gap-3">
                    <h1 className="text-xl font-bold text-white">{pentest.name}</h1>
                    <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold uppercase border ${VENDOR_COLORS[pentest.vendor] ?? VENDOR_COLORS.manual}`}>
                      {VENDOR_LABELS[pentest.vendor] ?? pentest.vendor}
                    </span>
                    <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold uppercase border ${SEVERITY_STYLES[pentest.severity] ?? ""}`}>
                      {pentest.severity}
                    </span>
                    <span className="inline-flex items-center gap-1 px-2.5 py-1 bg-emerald-50 text-emerald-700 text-xs font-semibold rounded-full">
                      {totalFindings} finding{totalFindings !== 1 ? "s" : ""}
                    </span>
                  </div>
                  <p className="text-sm text-[#8b949e] mt-0.5">
                    {pentest.status.replace("_", " ")}
                    {pentest.scope && ` \u00B7 ${pentest.scope}`}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <button
                  onClick={() => setEditOpen(true)}
                  className="inline-flex items-center gap-2 px-3 py-2 border border-[#30363d] rounded-lg hover:bg-[#21262d] transition-colors text-[#8b949e] hover:text-[#e6edf3] text-sm font-medium"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                  </svg>
                  Edit
                </button>
              </div>
            </div>

            {/* Tab navigation */}
            <div className="border-b border-[#30363d] mb-6">
              <nav className="flex gap-0 -mb-px">
                {TABS.map((tab) => {
                  const tabHref = `${basePath}${tab.href}`;
                  const isActive =
                    tab.href === ""
                      ? pathname === basePath
                      : pathname === tabHref || pathname.startsWith(tabHref + "/");
                  return (
                    <Link
                      key={tab.href}
                      href={tabHref}
                      className={`px-5 py-3 text-sm font-medium border-b-2 transition-colors ${
                        isActive
                          ? "border-primary text-primary"
                          : "border-transparent text-[#8b949e] hover:text-[#e6edf3] hover:border-[#30363d]"
                      }`}
                    >
                      {tab.label}
                    </Link>
                  );
                })}
              </nav>
            </div>

            {/* Tab content */}
            {children}
          </>
        )}
      </div>

      {/* Edit modal */}
      {pentest && (
        <CreatePentestModal
          pentest={pentest}
          open={editOpen}
          onClose={() => setEditOpen(false)}
          onSave={handleEditSave}
          onDelete={handleEditDelete}
        />
      )}
    </PentestContext.Provider>
  );
}
