"use client";

import { useState, useEffect } from "react";
import { createPentest, updatePentest, deletePentest } from "@/lib/api";
import type { Pentest } from "@/lib/types";

const VENDORS = [
  { id: "manual", label: "Manual" },
  { id: "synack", label: "Synack" },
  { id: "hackerone", label: "HackerOne" },
  { id: "intigriti", label: "Intigriti" },
];

const STATUSES = [
  { id: "planned", label: "Planned" },
  { id: "in_progress", label: "In Progress" },
  { id: "completed", label: "Completed" },
  { id: "cancelled", label: "Cancelled" },
];

const SEVERITIES = ["critical", "high", "medium", "low"];

interface CreatePentestModalProps {
  open: boolean;
  onClose: () => void;
  onSave: (pentest: Pentest) => void;
  onDelete?: () => void;
  pentest?: Pentest | null;
}

export default function CreatePentestModal({
  open,
  onClose,
  onSave,
  onDelete,
  pentest,
}: CreatePentestModalProps) {
  const isEdit = !!pentest;
  const [name, setName] = useState("");
  const [description, setDescription] = useState("");
  const [vendor, setVendor] = useState("manual");
  const [vendorId, setVendorId] = useState("");
  const [status, setStatus] = useState("planned");
  const [severity, setSeverity] = useState("medium");
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");
  const [scope, setScope] = useState("");
  const [saving, setSaving] = useState(false);
  const [deleting, setDeleting] = useState(false);
  const [confirmDelete, setConfirmDelete] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (open) {
      if (pentest) {
        setName(pentest.name);
        setDescription(pentest.description);
        setVendor(pentest.vendor);
        setVendorId(pentest.vendor_id);
        setStatus(pentest.status);
        setSeverity(pentest.severity);
        setStartDate(pentest.start_date ?? "");
        setEndDate(pentest.end_date ?? "");
        setScope(pentest.scope);
      } else {
        setName("");
        setDescription("");
        setVendor("manual");
        setVendorId("");
        setStatus("planned");
        setSeverity("medium");
        setStartDate("");
        setEndDate("");
        setScope("");
      }
      setError(null);
      setConfirmDelete(false);
    }
  }, [open, pentest]);

  if (!open) return null;

  async function handleSave() {
    if (!name.trim()) {
      setError("Name is required");
      return;
    }
    setSaving(true);
    setError(null);
    try {
      const data: Parameters<typeof updatePentest>[1] = {
        name: name.trim(),
        description,
        vendor: vendor as Pentest["vendor"],
        vendor_id: vendorId,
        status: status as Pentest["status"],
        severity: severity as Pentest["severity"],
        start_date: startDate || null,
        end_date: endDate || null,
        scope,
      };
      let result: Pentest;
      if (isEdit) {
        result = await updatePentest(pentest!.id, data);
      } else {
        result = await createPentest(data as Parameters<typeof createPentest>[0]);
      }
      onSave(result);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to save");
    } finally {
      setSaving(false);
    }
  }

  async function handleDelete() {
    if (!confirmDelete) {
      setConfirmDelete(true);
      return;
    }
    setDeleting(true);
    setError(null);
    try {
      await deletePentest(pentest!.id);
      onDelete?.();
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to delete");
    } finally {
      setDeleting(false);
    }
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />

      <div className="relative bg-[#1c2128] rounded-2xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="px-6 py-5 border-b border-[#262c34]">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-lg font-bold text-white">
                {isEdit ? "Edit Pentest" : "New Pentest"}
              </h2>
              <p className="text-sm text-[#8b949e] mt-0.5">
                {isEdit ? "Update pentest details." : "Create a new penetration testing campaign."}
              </p>
            </div>
            <button
              onClick={onClose}
              className="p-1.5 text-[#8b949e] hover:text-[#c9d1d9] rounded-lg hover:bg-[#262c34] transition-colors"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        {/* Body */}
        <div className="px-6 py-5 space-y-4">
          {/* Name */}
          <div>
            <label className="block text-sm font-medium text-[#e6edf3] mb-1.5">Name *</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="Q1 2026 External Pentest"
              className="w-full px-4 py-2.5 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white placeholder:text-[#484f58] focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
            />
          </div>

          {/* Description */}
          <div>
            <label className="block text-sm font-medium text-[#e6edf3] mb-1.5">Description</label>
            <textarea
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="Scope and objectives..."
              rows={3}
              className="w-full px-4 py-2.5 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white placeholder:text-[#484f58] focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none"
            />
          </div>

          {/* Vendor + Vendor ID */}
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-sm font-medium text-[#e6edf3] mb-1.5">Vendor</label>
              <select
                value={vendor}
                onChange={(e) => setVendor(e.target.value)}
                className="w-full px-4 py-2.5 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
              >
                {VENDORS.map((v) => (
                  <option key={v.id} value={v.id}>{v.label}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-[#e6edf3] mb-1.5">Vendor ID</label>
              <input
                type="text"
                value={vendorId}
                onChange={(e) => setVendorId(e.target.value)}
                placeholder="Optional"
                className="w-full px-4 py-2.5 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white placeholder:text-[#484f58] focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
              />
            </div>
          </div>

          {/* Status + Severity */}
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-sm font-medium text-[#e6edf3] mb-1.5">Status</label>
              <select
                value={status}
                onChange={(e) => setStatus(e.target.value)}
                className="w-full px-4 py-2.5 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
              >
                {STATUSES.map((s) => (
                  <option key={s.id} value={s.id}>{s.label}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-[#e6edf3] mb-1.5">Severity</label>
              <select
                value={severity}
                onChange={(e) => setSeverity(e.target.value)}
                className="w-full px-4 py-2.5 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
              >
                {SEVERITIES.map((s) => (
                  <option key={s} value={s}>{s.charAt(0).toUpperCase() + s.slice(1)}</option>
                ))}
              </select>
            </div>
          </div>

          {/* Dates */}
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-sm font-medium text-[#e6edf3] mb-1.5">Start Date</label>
              <input
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                className="w-full px-4 py-2.5 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#e6edf3] mb-1.5">End Date</label>
              <input
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                className="w-full px-4 py-2.5 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
              />
            </div>
          </div>

          {/* Scope */}
          <div>
            <label className="block text-sm font-medium text-[#e6edf3] mb-1.5">Scope</label>
            <textarea
              value={scope}
              onChange={(e) => setScope(e.target.value)}
              placeholder="e.g., *.example.com, 10.0.0.0/24, API endpoints"
              rows={2}
              className="w-full px-4 py-2.5 border border-[#30363d] rounded-lg text-sm bg-[#1c2128] text-white placeholder:text-[#484f58] focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none"
            />
          </div>

          {error && (
            <div className="p-3 bg-red-950/20 border border-red-500/30 rounded-lg text-red-400 text-sm">
              {error}
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t border-[#262c34] flex items-center justify-between">
          {isEdit ? (
            <button
              onClick={handleDelete}
              disabled={deleting}
              className={`inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-colors ${
                confirmDelete
                  ? "bg-red-600 text-white hover:bg-red-700"
                  : "text-red-400 border border-red-500/30 hover:bg-red-950/20"
              } disabled:opacity-50`}
            >
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
              </svg>
              {confirmDelete ? "Confirm Delete" : "Delete"}
            </button>
          ) : (
            <div />
          )}
          <div className="flex items-center gap-3">
            <button
              onClick={onClose}
              className="px-4 py-2 text-sm font-medium text-[#c9d1d9] border border-[#30363d] rounded-lg hover:bg-[#21262d] transition-colors"
            >
              Cancel
            </button>
            <button
              onClick={handleSave}
              disabled={saving}
              className="inline-flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-primary rounded-lg hover:bg-primary-hover transition-colors disabled:opacity-50"
            >
              {saving && (
                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
              )}
              {saving ? "Saving..." : isEdit ? "Save Changes" : "Create Pentest"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
