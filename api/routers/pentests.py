"""Router for pentest campaign management and findings."""

from __future__ import annotations

from typing import Optional

from fastapi import APIRouter, Depends, HTTPException, Query
from pydantic import BaseModel, Field

from api.auth import get_current_user
from api.pentests_database import (
    create_pentest,
    list_pentests,
    get_pentest,
    update_pentest,
    delete_pentest,
    create_finding,
    list_findings,
    get_finding,
    update_finding,
    get_finding_counts,
    bulk_import_findings,
    list_pentest_checks,
)

router = APIRouter(prefix="/api/pentests", tags=["pentests"])


# --------------- schemas ---------------


class CreatePentestRequest(BaseModel):
    name: str = Field(min_length=1, max_length=255)
    description: str = Field(default="", max_length=5000)
    vendor: str = Field(default="manual", max_length=100)
    vendor_id: str = Field(default="", max_length=255)
    status: str = Field(default="planned", max_length=30)
    severity: str = Field(default="medium", max_length=30)
    start_date: str | None = None
    end_date: str | None = None
    scope: str = Field(default="", max_length=5000)


class UpdatePentestRequest(BaseModel):
    name: str | None = Field(default=None, min_length=1, max_length=255)
    description: str | None = Field(default=None, max_length=5000)
    vendor: str | None = Field(default=None, max_length=100)
    vendor_id: str | None = Field(default=None, max_length=255)
    status: str | None = Field(default=None, max_length=30)
    severity: str | None = Field(default=None, max_length=30)
    start_date: str | None = None
    end_date: str | None = None
    scope: str | None = Field(default=None, max_length=5000)


class CreateFindingRequest(BaseModel):
    title: str = Field(min_length=1, max_length=500)
    description: str = Field(default="", max_length=10_000)
    severity: str = Field(default="medium", max_length=30)
    cvss_score: float | None = Field(default=None, ge=0.0, le=10.0)
    status: str = Field(default="open", max_length=30)
    category: str = Field(default="", max_length=100)
    affected_url: str = Field(default="", max_length=2000)
    remediation_notes: str = Field(default="", max_length=10_000)
    evidence: str = Field(default="", max_length=50_000)
    discovered_at: str | None = None
    cwe_id: str = Field(default="", max_length=20)
    cve_id: str = Field(default="", max_length=30)
    request_data: str = Field(default="", max_length=50_000)
    response_data: str = Field(default="", max_length=50_000)
    validation_status: str = Field(default="unverified", max_length=30)
    validation_notes: str = Field(default="", max_length=5000)
    check_rule_code: str = Field(default="", max_length=100)


class UpdateFindingRequest(BaseModel):
    title: str | None = Field(default=None, min_length=1, max_length=500)
    description: str | None = Field(default=None, max_length=10_000)
    severity: str | None = Field(default=None, max_length=30)
    cvss_score: float | None = Field(default=None, ge=0.0, le=10.0)
    status: str | None = Field(default=None, max_length=30)
    category: str | None = Field(default=None, max_length=100)
    affected_url: str | None = Field(default=None, max_length=2000)
    remediation_notes: str | None = Field(default=None, max_length=10_000)
    evidence: str | None = Field(default=None, max_length=50_000)
    resolved_at: str | None = None
    cwe_id: str | None = Field(default=None, max_length=20)
    cve_id: str | None = Field(default=None, max_length=30)
    request_data: str | None = Field(default=None, max_length=50_000)
    response_data: str | None = Field(default=None, max_length=50_000)
    validation_status: str | None = Field(default=None, max_length=30)
    validation_notes: str | None = Field(default=None, max_length=5000)
    check_rule_code: str | None = Field(default=None, max_length=100)


class ImportFindingsRequest(BaseModel):
    findings: list[dict]


# --------------- helpers ---------------


def _pentest_with_counts(pentest: dict) -> dict:
    """Attach finding_counts to a pentest dict."""
    pentest["finding_counts"] = get_finding_counts(pentest["id"])
    return pentest


# --------------- Pentest CRUD ---------------


@router.get("")
async def list_pentests_endpoint(user_email: str = Depends(get_current_user)):
    """List pentests for the authenticated user."""
    pentests = list_pentests(user_email)
    return [_pentest_with_counts(p) for p in pentests]


@router.post("", status_code=201)
async def create_pentest_endpoint(body: CreatePentestRequest, user_email: str = Depends(get_current_user)):
    """Create a new pentest."""
    pentest_id = create_pentest(
        user_email=user_email,
        name=body.name,
        description=body.description,
        vendor=body.vendor,
        vendor_id=body.vendor_id,
        status=body.status,
        severity=body.severity,
        start_date=body.start_date,
        end_date=body.end_date,
        scope=body.scope,
    )
    pentest = get_pentest(pentest_id)
    return _pentest_with_counts(pentest)


# IMPORTANT: Static path segments must be defined BEFORE /{pentest_id}
# to avoid FastAPI matching them as a pentest_id parameter.


@router.get("/checks")
async def list_checks_endpoint(group: Optional[str] = Query(None)):
    """List all pentest check categories, optionally filtered by group."""
    return list_pentest_checks(group=group or "")


@router.patch("/findings/{finding_id}")
async def update_finding_endpoint(finding_id: str, body: UpdateFindingRequest, user_email: str = Depends(get_current_user)):
    """Update a finding's fields."""
    finding = get_finding(finding_id)
    if not finding:
        raise HTTPException(status_code=404, detail="Finding not found")
    # Verify ownership
    pentest = get_pentest(finding["pentest_id"])
    if not pentest or pentest["user_email"] != user_email:
        raise HTTPException(status_code=404, detail="Finding not found")

    updates = {k: v for k, v in body.model_dump().items() if v is not None}
    if updates:
        update_finding(finding_id, **updates)
    updated = get_finding(finding_id)
    return updated


@router.get("/{pentest_id}")
async def get_pentest_endpoint(pentest_id: str, user_email: str = Depends(get_current_user)):
    """Get a single pentest with finding counts."""
    pentest = get_pentest(pentest_id)
    if not pentest:
        raise HTTPException(status_code=404, detail="Pentest not found")
    if pentest["user_email"] != user_email:
        raise HTTPException(status_code=404, detail="Pentest not found")
    return _pentest_with_counts(pentest)


@router.put("/{pentest_id}")
async def update_pentest_endpoint(pentest_id: str, body: UpdatePentestRequest, user_email: str = Depends(get_current_user)):
    """Update a pentest's mutable fields."""
    pentest = get_pentest(pentest_id)
    if not pentest:
        raise HTTPException(status_code=404, detail="Pentest not found")
    if pentest["user_email"] != user_email:
        raise HTTPException(status_code=404, detail="Pentest not found")

    updates = {k: v for k, v in body.model_dump().items() if v is not None}
    if updates:
        update_pentest(pentest_id, **updates)

    return _pentest_with_counts(get_pentest(pentest_id))


@router.delete("/{pentest_id}")
async def delete_pentest_endpoint(pentest_id: str, user_email: str = Depends(get_current_user)):
    """Delete a pentest and all its findings."""
    pentest = get_pentest(pentest_id)
    if not pentest:
        raise HTTPException(status_code=404, detail="Pentest not found")
    if pentest["user_email"] != user_email:
        raise HTTPException(status_code=404, detail="Pentest not found")
    delete_pentest(pentest_id)
    return {"detail": "deleted"}


# --------------- Findings ---------------


@router.get("/{pentest_id}/findings")
async def list_findings_endpoint(
    pentest_id: str,
    status: Optional[str] = Query(None),
    severity: Optional[str] = Query(None),
    user_email: str = Depends(get_current_user),
):
    """List findings for a pentest, with optional filters."""
    pentest = get_pentest(pentest_id)
    if not pentest:
        raise HTTPException(status_code=404, detail="Pentest not found")
    if pentest["user_email"] != user_email:
        raise HTTPException(status_code=404, detail="Pentest not found")
    return list_findings(
        pentest_id,
        status=status or "",
        severity=severity or "",
    )


@router.post("/{pentest_id}/findings", status_code=201)
async def create_finding_endpoint(pentest_id: str, body: CreateFindingRequest, user_email: str = Depends(get_current_user)):
    """Create a new finding."""
    pentest = get_pentest(pentest_id)
    if not pentest:
        raise HTTPException(status_code=404, detail="Pentest not found")
    if pentest["user_email"] != user_email:
        raise HTTPException(status_code=404, detail="Pentest not found")

    finding_id = create_finding(
        pentest_id=pentest_id,
        title=body.title,
        description=body.description,
        severity=body.severity,
        cvss_score=body.cvss_score,
        status=body.status,
        category=body.category,
        affected_url=body.affected_url,
        remediation_notes=body.remediation_notes,
        evidence=body.evidence,
        discovered_at=body.discovered_at,
        cwe_id=body.cwe_id,
        cve_id=body.cve_id,
        request_data=body.request_data,
        response_data=body.response_data,
        validation_status=body.validation_status,
        validation_notes=body.validation_notes,
        check_rule_code=body.check_rule_code,
    )
    return get_finding(finding_id)


@router.post("/{pentest_id}/import")
async def import_findings_endpoint(pentest_id: str, body: ImportFindingsRequest, user_email: str = Depends(get_current_user)):
    """Bulk import findings for a pentest."""
    pentest = get_pentest(pentest_id)
    if not pentest:
        raise HTTPException(status_code=404, detail="Pentest not found")
    if pentest["user_email"] != user_email:
        raise HTTPException(status_code=404, detail="Pentest not found")

    count = bulk_import_findings(pentest_id, body.findings)
    return {"imported": count}
